<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Earth Tekniks Dashboard</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    body { background-color: #f4f4f4; margin: 0; font-family: Arial, sans-serif; }
    .sidebar {
      width: 220px;
      background-color: #2d3e50;
      color: white;
      padding: 20px 10px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
    }
    .sidebar h3 { font-size: 22px; text-align: center; margin-bottom: 30px; }
    .sidebar ul { list-style: none; padding: 0; }
    .sidebar ul li { margin-bottom: 10px; }
    .sidebar ul li a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 10px;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .sidebar ul li a:hover,
    .sidebar ul li a.active { background-color: #1a2533; font-weight: bold; }
    .main-content { margin-left: 240px; padding: 30px; }
    .card { padding: 20px; text-align: center; color: white; border-radius: 10px; }
    .blue { background-color: #5bc0de; }
    .green { background-color: #5cb85c; }
    .orange { background-color: #f0ad4e; }
    .purple { background-color: #a167c9; }
    .device-info-container {
  border: 1px solid #007BFF;
  border-radius: 5px;
  background: #fff;
  margin-bottom: 20px;
  box-shadow: 0 0 10px rgba(0, 123, 255, 0.1);
}
.device-info-container {
  border: 1px solid #007BFF;
  border-radius: 6px;
  background: #fff;
  margin-bottom: 20px;
  box-shadow: 0 2px 6px rgba(0, 123, 255, 0.15);
  overflow: hidden;
}

.device-info-header {
  background-color: #007bff;
  color: white;
  font-weight: bold;
  font-size: 16px;
  padding: 12px 20px;
}

.device-info-body {
  padding: 0 20px;
}

.device-info-row {
  display: flex;
  justify-content: space-between;
  padding: 12px 0;
  border-bottom: 1px solid #eaeaea;
  font-size: 14px;
}

.device-info-row:last-child {
  border-bottom: none;
}

@media (max-width: 576px) {
  .device-info-row {
    flex-direction: column;
    align-items: flex-start;
  }
}

  </style>
</head>
<body>
  <!-- Header -->
  <nav class="navbar navbar-expand-lg" style="background-color: #2c3e50;">
    <div class="container-fluid">
      <a class="navbar-brand d-flex align-items-center text-white" href="#">
        <img src="logo-icon.png" alt="Logo" width="30" height="30" class="me-2">
        <strong>Earth Tekniks</strong>
      </a>
      <div class="d-flex align-items-center gap-4 me-4">
        <a href="index.php" class="text-white" title="Home">
          <i class="bi bi-house-door-fill fs-5"></i>
        </a>
        <a href="#" class="text-white" title="Print">
          <i class="bi bi-printer-fill fs-5"></i>
        </a>
        <a href="logout.php" class="text-white" title="Logout">
          <i class="bi bi-power fs-5"></i>
        </a>
      </div>
    </div>
  </nav>

  <!-- Sidebar -->
  <div class="sidebar">
    <h3>Earth Tekniks</h3>
    <ul>
      <li><a href="index.html" class="active">Dashboard</a></li>
      <li><a id="diagnosticsLink" href="#">Diagnostics</a></li>

      <li><a href="report.html">DT Reports</a></li>
      <li><a href="settings.php">Settings</a></li>
      <li><a href="alarm.html">Alarm</a></li>
      <li><a href="information.html">Information</a></li>
    </ul>
  </div>

  <!-- Main Content -->
  <div class="main-content">
    <div id="device-info" class="mb-4"></div>

    <div class="row">
      <div class="col-md-6"><div class="card blue"><h3>Moisture</h3><h2 id="moisture">--%</h2></div></div>
      <div class="col-md-3"><div class="card green"><h5>Gauge Status</h5><h4 id="status">--</h4></div></div>
      <div class="col-md-3"><div class="card orange"><h5>Moisture (Min)</h5><h4 id="min">--%</h4></div></div>
    </div>

    <div class="row mt-3">
      <div class="col-md-3"><div class="card purple"><h5>Moisture (Avg)</h5><h4 id="avg">--%</h4></div></div>
      <div class="col-md-3"><div class="card blue"><h5>Moisture (Max)</h5><h4 id="max">--%</h4></div></div>
      <div class="col-md-6"><div class="card orange"><h5>Gauge Temperature</h5><h4 id="temp">--°C</h4></div></div>
    </div>

    <div class="text-center mt-4">
      <a href="add_moisture.html" class="btn btn-success">➕ Add Moisture Data</a>
    </div>

    <div class="mt-5">
      <h4>History Graph</h4>
      <div id="chart-scroll-container" style="width: 100%; overflow-x: auto;">
        <div style="width: 1500px;">
          <canvas id="historyChart"></canvas>
        </div>
      </div>
    </div>

    <!-- Device Information Table styled like your main data table -->


  <script>
    const urlParams = new URLSearchParams(window.location.search);
    const deviceId = urlParams.get("device_id");
    let chart, lastId = 0;
async function loadDeviceInfo(id) {
  const res = await fetch(`get_device_info.php?device_id=${id}`);
  const info = await res.json();

  if (info.error) {
    document.getElementById("device-info").innerHTML = `<div class="alert alert-danger">${info.error}</div>`;
    return;
  }

  document.getElementById("device-info").innerHTML = `
    <div class="device-info-container">
      <div class="device-info-header">DEVICE INFORMATION</div>
      <div class="device-info-body">
        <div class="device-info-row"><span>Company Name</span><span>${info.company_name || "N/A"}</span></div>
        <div class="device-info-row"><span>Device Id</span><span>${info.id}</span></div>
        <div class="device-info-row"><span>Device Name</span><span>${info.device_name}</span></div>
        <div class="device-info-row"><span>Serial Number</span><span>${info.serial_number}</span></div>
        <div class="device-info-row"><span>Location</span><span>${info.location || "N/A"}</span></div>
      </div>
    </div>
  `;
}


    function initChart() {
      const ctx = document.getElementById("historyChart").getContext("2d");
      chart = new Chart(ctx, {
        type: "line",
        data: {
          labels: [],
          datasets: [{
            label: "Moisture %",
            data: [],
            fill: false,
            borderColor: "skyblue",
            tension: 0.3,
            pointBackgroundColor: "white"
          }]
        },
        options: {
          responsive: true,
          scales: {
            y: { min: 0, max: 100, ticks: { stepSize: 10 } },
            x: { title: { display: true, text: "Timestamp" } }
          }
        }
      });
    }

    function updateCards(row) {
      document.getElementById("moisture").innerText = row.moisture_percentage + "%";
      document.getElementById("min").innerText = row.moisture_min + "%";
      document.getElementById("max").innerText = row.moisture_max + "%";
      document.getElementById("avg").innerText = parseFloat(row.moisture_avg).toFixed(2) + "%";
      document.getElementById("temp").innerText = row.temperature + "°C";
      document.getElementById("status").innerText = row.gauge_status?.trim() || "N/A";
    }

    async function loadInitialData() {
      const res = await fetch(`get_all.php${deviceId ? `?device_id=${deviceId}` : ""}`);
      const data = await res.json();
      if (!data.length) return;
      initChart();
      data.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
      data.forEach(row => {
        chart.data.labels.push(row.timestamp);
        chart.data.datasets[0].data.push(parseFloat(row.moisture_percentage));
      });
      chart.update();
      lastId = Math.max(...data.map(r => parseInt(r.id)));
      updateCards(data[data.length - 1]);
    }

    async function checkNewData() {
      const res = await fetch(`get_latest_iot_data.php?last_id=${lastId}${deviceId ? `&device_id=${deviceId}` : ""}`);
      const newData = await res.json();
      if (newData.length) {
        newData.forEach(row => {
          chart.data.labels.push(row.timestamp);
          chart.data.datasets[0].data.push(parseFloat(row.moisture_percentage));
          lastId = parseInt(row.id);
        });
        chart.update();
        updateCards(newData[newData.length - 1]);
      }
    }

    window.onload = async () => {
      if (deviceId) await loadDeviceInfo(deviceId);
      await loadInitialData();
      setInterval(checkNewData, 15000);
    };
      const diagnosticsLink = document.getElementById("diagnosticsLink");
  if (deviceId) {
    diagnosticsLink.href = `diagnostics.php?device_id=${deviceId}`;
  } else {
    diagnosticsLink.href = "diagnostics.php";
  }
  </script>
</body>
</html>
