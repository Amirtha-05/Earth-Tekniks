<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Reports - Earth Tekniks</title>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <style>
    body {
      background: #f8f9fa;
      margin: 0;
      padding: 0;
    }
    .sidebar {
      width: 220px;
      background-color: #2d3e50;
      color: white;
      padding: 20px 10px;
      height: 100vh;
      position: fixed;
      top: 0;
      left: 0;
      overflow-y: auto;
    }
    .sidebar h3 {
      font-size: 22px;
      text-align: center;
      margin-bottom: 30px;
    }
    .sidebar ul {
      list-style: none;
      padding: 0;
    }
    .sidebar ul li {
      margin-bottom: 10px;
    }
    .sidebar ul li a {
      color: white;
      text-decoration: none;
      display: block;
      padding: 10px;
      border-radius: 5px;
      transition: background-color 0.3s ease;
    }
    .sidebar ul li a:hover,
    .sidebar ul li a.active {
      background-color: #1a2533;
      font-weight: bold;
    }
    .main-content {
      margin-left: 220px;
      padding: 32px 24px 24px 24px;
    }
    @media (max-width: 767px) {
      .sidebar {
        width: 100vw;
        height: auto;
        position: relative;
        margin-bottom: 1rem;
      }
      .main-content {
        margin-left: 0;
        padding: 16px 8px;
      }
    }
  </style>
</head>
<body>
  <!-- Navbar/Header -->
<nav class="navbar navbar-expand-lg" style="background-color: #2c3e50;">
  <div class="container-fluid">
    <a class="navbar-brand d-flex align-items-center text-white" href="#">
      <img src="logo-icon.png" alt="Logo" width="30" height="30" class="me-2">
      <strong>Earth Tekniks</strong>
    </a>
    <div class="d-flex align-items-center gap-4 me-4">
      <!-- Home button goes through index.php with ref -->
      <a href="index.php?ref=report.html" class="text-white" title="Home">
        <i class="bi bi-house-door-fill fs-5"></i>
      </a>
      <a href="#" class="text-white" title="Print">
        <i class="bi bi-printer-fill fs-5"></i>
      </a>
      <a href="logout.php" class="text-white" title="Logout">
        <i class="bi bi-power fs-5"></i>
      </a>
    </div>
  </div>
</nav>


  <div class="sidebar">
  <h3>Earth Tekniks</h3>
  <ul>
    <li><a href="index.html" class="<?= basename($_SERVER['PHP_SELF']) == 'index.html' ? 'active' : '' ?>">Dashboard</a></li>
    <li><a href="diagnostics.php" class="<?= basename($_SERVER['PHP_SELF']) == 'diagnostics.php' ? 'active' : '' ?>">Diagnostics</a></li>
    <li><a href="report.html" class="<?= basename($_SERVER['PHP_SELF']) == 'report.html' ? 'active' : '' ?>">DT Reports</a></li>
    <li><a href="settings.php" class="<?= basename($_SERVER['PHP_SELF']) == 'settings.php' ? 'active' : '' ?>">Settings</a></li>
    <li><a href="alarm.html" class="<?= basename($_SERVER['PHP_SELF']) == 'alarm.html' ? 'active' : '' ?>">Alarm</a></li>
    <li><a href="information.html" class="<?= basename($_SERVER['PHP_SELF']) == 'information.html' ? 'active' : '' ?>">Information</a></li>
  </ul>
</div>


<div class="main-content">
  <div class="container-fluid">
    <h4 class="mt-4">Report History</h4>

    <div class="bg-white p-3 rounded mb-4">
      <canvas id="reportChart" height="100"></canvas>
    </div>

    <div class="mb-3">
      <button class="btn btn-sm btn-primary" onclick="exportToExcel()">Export to Excel</button>
      <button class="btn btn-sm btn-danger" onclick="exportToPDF()">Export to PDF</button>
    </div>

    <!-- Filter Section -->
    <div class="row mb-3 align-items-end g-2">
      <div class="col-md-2">
        <label for="deviceFilter" class="form-label">Device ID</label>
        <input type="text" id="deviceFilter" class="form-control" placeholder="Enter Device ID">
      </div>
      <div class="col-md-2">
        <label for="statusFilter" class="form-label">Status</label>
        <select id="statusFilter" class="form-select">
          <option value="">All</option>
          <option value="GOOD">GOOD</option>
          <option value="LOW">LOW</option>
          <option value="WARNING">WARNING</option>
        </select>
      </div>
      <div class="col-md-2">
        <label for="fromDate" class="form-label">From Date</label>
        <input type="date" id="fromDate" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="fromTime" class="form-label">From Time</label>
        <input type="time" id="fromTime" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="toDate" class="form-label">To Date</label>
        <input type="date" id="toDate" class="form-control">
      </div>
      <div class="col-md-2">
        <label for="toTime" class="form-label">To Time</label>
        <input type="time" id="toTime" class="form-control">
      </div>
    </div>

    <div class="row mb-4 justify-content-center">
      <div class="col-auto">
        <button class="btn btn-sm btn-secondary me-2" onclick="applyFilter()">Apply Filter</button>
        <button class="btn btn-sm btn-outline-secondary" onclick="clearFilter(); applyFilter();">Clear</button>
      </div>
    </div>

    <div class="table-container">
      <table class="table table-bordered" id="reportTable">
        <thead class="table-dark text-center">
          <tr>
            <th>Serial No.</th>
            <th>Device ID</th>
            <th>Timestamp</th>
            <th>Moisture %</th>
            <th>Min</th>
            <th>Max</th>
            <th>Avg</th>
            <th>Status</th>
            <th>Temperature</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>
</div>

<script>
// existing JS stays the same...
</script>
</body>
</html>


<script>
let reportChart;
let allData = [];

function initReportChart(labels, dataPoints) {
  const ctx = document.getElementById('reportChart').getContext('2d');
  reportChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels,
      datasets: [{
        label: 'Moisture %',
        data: dataPoints,
        borderColor: 'skyblue',
        backgroundColor: 'rgba(135,206,250,0.3)',
        fill: true,
        tension: 0.3
      }]
    },
    options: {
      responsive: true,
      scales: {
        y: {
          beginAtZero: true,
          max: 100,
          title: { display: true, text: 'Moisture %' }
        },
        x: { title: { display: true, text: 'Timestamp' } }
      }
    }
  });
}

async function loadReportData() {
  const res = await fetch('get_all.php');
  allData = await res.json();
  displayTableAndChart(allData);
}

function applyFilter() {
  const deviceInput = document.getElementById('deviceFilter').value.trim().toLowerCase();
  const status = document.getElementById('statusFilter').value;
  const fromDate = document.getElementById('fromDate').value;
  const fromTime = document.getElementById('fromTime').value;
  const toDate = document.getElementById('toDate').value;
  const toTime = document.getElementById('toTime').value;

  let filtered = allData;

  if (deviceInput) {
    filtered = filtered.filter(row => {
      return String(row.device_id).includes(deviceInput) || (row.device_name?.toLowerCase().includes(deviceInput));
    });
  }

  if (status) {
    filtered = filtered.filter(row => row.gauge_status?.toLowerCase() === status.toLowerCase());
  }

  if (fromDate) {
    filtered = filtered.filter(row => row.timestamp >= fromDate);
  }

  if (toDate) {
    filtered = filtered.filter(row => row.timestamp <= toDate + " 23:59:59");
  }

  if (fromTime) {
    filtered = filtered.filter(row => {
      const rowTime = row.timestamp.split(' ')[1]?.substring(0, 5);
      return rowTime && rowTime >= fromTime;
    });
  }

  if (toTime) {
    filtered = filtered.filter(row => {
      const rowTime = row.timestamp.split(' ')[1]?.substring(0, 5);
      return rowTime && rowTime <= toTime;
    });
  }

  displayTableAndChart(filtered);
}

function clearFilter() {
  document.getElementById('deviceFilter').value = '';
  document.getElementById('statusFilter').value = '';
  document.getElementById('fromDate').value = '';
  document.getElementById('fromTime').value = '';
  document.getElementById('toDate').value = '';
  document.getElementById('toTime').value = '';
}

function displayTableAndChart(data) {
  const tableBody = document.querySelector('#reportTable tbody');
  const labels = [], points = [];
  tableBody.innerHTML = '';

  data.forEach((row, index) => {
    labels.push(row.timestamp);
    points.push(row.moisture_percentage);

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${index + 1}</td>
      <td>${row.device_id}</td>
      <td>${row.timestamp}</td>
      <td>${row.moisture_percentage}</td>
      <td>${row.moisture_min}</td>
      <td>${row.moisture_max}</td>
      <td>${row.moisture_avg}</td>
      <td>${row.gauge_status}</td>
      <td>${row.temperature}</td>
    `;
    tableBody.appendChild(tr);
  });

  if (reportChart) reportChart.destroy();
  initReportChart(labels, points);
}

function exportToExcel() {
  const table = document.getElementById('reportTable');
  const wb = XLSX.utils.book_new();
  const ws = XLSX.utils.table_to_sheet(table, { raw: true });
  XLSX.utils.book_append_sheet(wb, ws, "Report");
  XLSX.writeFile(wb, 'Earth_Tekniks_Report.xlsx');
}

async function exportToPDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  doc.text("Earth Tekniks Report", 10, 10);
  doc.autoTable({ html: '#reportTable', startY: 20, styles: { fontSize: 8 } });
  doc.save("Earth_Tekniks_Report.pdf");
}

window.onload = loadReportData;
</script>
</body>
</html>